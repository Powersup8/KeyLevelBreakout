// © EMA Pullback Backtest Strategy
// Backtests pullback entries to 9 EMA after strong moves
// Short side (Puts): bull candle above EMA → bear pullback to EMA
// Long side (Calls): bear candle below EMA → bull pullback to EMA
// Designed for 5-min charts, ATR from Daily
//@version=6
strategy("EMA Pullback Backtest", overlay=true,
     default_qty_type=strategy.percent_of_equity, default_qty_value=100,
     initial_capital=10000, commission_type=strategy.commission.percent,
     commission_value=0.1, slippage=1)

// ─── Inputs ────────────────────────────────────────────────
i_enableShort  = input.bool(true,    "Enable Short (Puts)",       group="Direction")
i_enableLong   = input.bool(true,    "Enable Long (Calls)",       group="Direction")
i_qualShort    = input.string("Close", "Short Qualify Mode",      options=["Close", "High"], group="Direction")
i_qualLong     = input.string("Close", "Long Qualify Mode",       options=["Close", "Low"],  group="Direction")
i_retestMode   = input.string("EMA Touch", "Retest Mode",         options=["EMA Touch", "Any Opposite"], group="Direction")
i_atrThresh    = input.float(20.0,   "ATR Threshold %",           minval=1.0, maxval=100.0, step=1.0, group="Parameters")
i_atrLen       = input.int(14,       "ATR Length (Daily)",         minval=1, group="Parameters")
i_emaLen       = input.int(9,        "EMA Length",                 minval=1, group="Parameters")

// ─── EMA ───────────────────────────────────────────────────
ema9 = ta.ema(close, i_emaLen)
plot(ema9, "9 EMA", color.new(color.yellow, 30), 1)

// ─── Daily ATR (non-repainting) ────────────────────────────
dailyATR = request.security(syminfo.tickerid, "D", ta.atr(i_atrLen)[1], lookahead=barmerge.lookahead_on)
atrOffset = dailyATR * i_atrThresh / 100.0

// ─── Candle Properties ────────────────────────────────────
isBull = close > open
isBear = close < open

// ─── SHORT SIDE (Puts) ────────────────────────────────────

// State: 0=SCANNING, 1=WAITING_FOR_PULLBACK, 2=IN_TRADE
var int   shortState     = 0
var float shortQualHigh  = na
var float shortQualLow   = na
var float shortQualClose = na
var bool  shortCrossed  = false
bool      shortEntered  = false

if i_enableShort
    if shortState == 0 or shortState == 1
        // Check for qualifying bullish candle
        qualAbove = i_qualShort == "Close" ? close >= ema9 + atrOffset : high >= ema9 + atrOffset
        strongBody = math.abs(close - open) > (high - low) * 0.75
        freshCross = close[1] <= ema9
        if isBull and qualAbove and strongBody and freshCross
            shortQualHigh  := high
            shortQualLow   := low
            shortQualClose := close
            shortState     := 1

    if shortState == 1
        // Invalidate if EMA rose past qualifying candle's close
        if shortQualClose <= ema9
            shortState := 0
        shortRetest = i_retestMode == "EMA Touch" ? (isBear and low <= ema9) : isBear
        if shortState == 1 and shortRetest
            entryPrice = shortQualHigh - (shortQualHigh - shortQualLow) / 3.0
            slPrice    = shortQualHigh
            strategy.entry("Short", strategy.short, limit=entryPrice)
            shortState   := 2
            shortCrossed := false
            shortEntered  = true

    if shortState == 2 and not shortEntered
        if not shortCrossed and close < ema9
            shortCrossed := true
        // Exit: SL (always active) or body above EMA (only after crossing)
        if high >= shortQualHigh
            strategy.close("Short", comment="SL")
            shortState := 0
        else if shortCrossed and math.min(open, close) > ema9
            strategy.close("Short", comment="Exit")
            shortState := 0

// ─── LONG SIDE (Calls) ───────────────────────────────────

var int   longState     = 0
var float longQualHigh  = na
var float longQualLow   = na
var float longQualClose = na
var bool  longCrossed  = false
bool      longEntered  = false

if i_enableLong
    if longState == 0 or longState == 1
        // Check for qualifying bearish candle
        qualBelow = i_qualLong == "Close" ? close <= ema9 - atrOffset : low <= ema9 - atrOffset
        strongBody = math.abs(close - open) > (high - low) * 0.75
        freshCross = close[1] >= ema9
        if isBear and qualBelow and strongBody and freshCross
            longQualHigh  := high
            longQualLow   := low
            longQualClose := close
            longState     := 1

    if longState == 1
        // Invalidate if EMA dropped past qualifying candle's close
        if longQualClose >= ema9
            longState := 0
        longRetest = i_retestMode == "EMA Touch" ? (isBull and high >= ema9) : isBull
        if longState == 1 and longRetest
            entryPrice = longQualLow + (longQualHigh - longQualLow) / 3.0
            slPrice    = longQualLow
            strategy.entry("Long", strategy.long, limit=entryPrice)
            longState   := 2
            longCrossed := false
            longEntered  = true

    if longState == 2 and not longEntered
        if not longCrossed and close > ema9
            longCrossed := true
        // Exit: SL (always active) or body below EMA (only after crossing)
        if low <= longQualLow
            strategy.close("Long", comment="SL")
            longState := 0
        else if longCrossed and math.max(open, close) < ema9
            strategy.close("Long", comment="Exit")
            longState := 0

// ─── Plot Shapes ──────────────────────────────────────────
plotshape(i_enableShort and shortState[1] == 1 and shortState == 2,
     "Short Entry", shape.triangledown, location.abovebar, color.red, size=size.small, text="Put")
plotshape(i_enableShort and shortState[1] == 2 and shortState == 0,
     "Short Exit", shape.triangleup, location.belowbar, color.orange, size=size.small, text="Exit")
plotshape(i_enableLong and longState[1] == 1 and longState == 2,
     "Long Entry", shape.triangleup, location.belowbar, color.green, size=size.small, text="Call")
plotshape(i_enableLong and longState[1] == 2 and longState == 0,
     "Long Exit", shape.triangledown, location.abovebar, color.orange, size=size.small, text="Exit")
