# KeyLevelBreakout Signal Generation — Code Exploration

## 1. Retest Logic (lines 889-992)

**Where retests fire:** Inside the per-level retest monitoring blocks at lines 904-947 (bull) and 949-992 (bear).

**Conditions for a bull retest (line 922):**
```pine
if low <= lvl + retestBuf and close > lvl - rearmBuf
```
- Price must dip back down to within `retestBuf` of the broken level (wick touches proximity zone)
- Close must stay above the level minus `rearmBuf` (still holding)
- Must be in state `bRTState == 1` (monitoring active after a breakout)
- `bar_index > bRTBar0` — skips the breakout bar itself to prevent self-retest (line 921)

**Conditions for a bear retest (line 967):**
```pine
if high >= lvl - retestBuf and close < lvl + rearmBuf
```
Mirror logic: price must push up near the level, close must stay below.

**Same-bar retest suppression:**
- The `bar_index > bRTBar0` check (lines 921, 966) prevents the breakout bar from self-retesting
- `bRTBar0` is set to `bar_index - 1` at breakout setup (lines 771, 886) — this means the check is `bar_index > (breakout_chart_bar - 1)`, so the breakout bar itself passes (`bar_index == breakout_chart_bar` > `breakout_chart_bar - 1`). **This is a potential bug** — it should be `bar_index > bRTBar0 + 1` or `bRTBar0` should be set to `bar_index` (not `bar_index - 1`).
- Per-level `bRT[i]` bool flags prevent re-firing the same level (once retested, stays true)
- **No cross-level same-bar suppression exists** — if two levels are close together, both can retest on the same bar independently

**Retest window:** `retestMaxElapsed` (line 293) — configurable: 10 sig bars (Short), 30 (Extended), or 99999 (Session). When elapsed, state auto-promotes to pass (lines 942-947, 987-992).

**Retest labels:** Independent label created at retest time (lines 932-934, 977-979), plus the original breakout label gets suffix appended (lines 940-941, 985-986).

---

## 2. Reclaim Logic (lines 595-640)

**Where reclaims are generated:** Reclaims are NOT a separate signal type. They are a **variant of reversal signals** with a different label prefix.

**What triggers a reclaim:** A reversal signal fires AND the `hadBrk*` flag is true for that level. The `hadBrk*` flags are set during the re-arm logic (lines 398-423) — when a breakout flag is cleared because price closed back through the level.

**Flow:**
1. Breakout fires at level X, sets `xPMH = true` (line 496)
2. Price closes back below level X minus `rearmBuf` (line 400): `xPMH = false`, `hadBrkPMH = true`
3. Later, a reversal signal fires at that level — the label gets `~~` prefix instead of `~` (lines 598-640)

**Volume/position thresholds:** Same as reversals — `volPassBull`/`volPassBear` (inherited from the `bullRev`/`bearRev` helpers). The reclaim label gets slightly lower alpha (more opaque) via `revBullAlpha` (line 654).

**No additional conditions beyond reversal + hadBrk flag.**

---

## 3. CONF System (lines 742-773, 857-887, 904-992)

### Confirmation Setup
- When a breakout fires with `i_confirm` enabled, per-level tracking arrays are initialized (lines 752-772 bull, 867-887 bear)
- `bRTState` / `sRTState` set to 1 (monitoring)
- Most conservative level calculated: lowest for bull (line 760-769), highest for bear (874-883)

### Auto-Promote (lines 744-750, 859-865)
- If a **new breakout** fires while a previous breakout is still in monitoring state (`bRTState == 1`), the previous one gets auto-promoted to pass
- Label updated with `\n` + checkmark, debug updated to checkmark
- Only happens when NOT in retest-only mode

### Regular Confirmation (Retest)
- Each chart-TF bar checks proximity to tracked levels (lines 919-926, 964-971)
- When retest detected: label gets retest suffix with superscript bar count
- When price fails (closes past conservative level minus rearmBuf): state = -1, label gets X mark (lines 907-916, 952-961)

### Window Expiry (lines 942-947, 987-992)
- If monitoring window expires without failure, confirmation auto-promotes to pass

### CONF Line Generation
- Checkmark / X mark appended to breakout label text
- Retest suffix lines generated by `buildRetestSuffix()` (lines 892-902)

---

## 4. Reversal Logic (lines 459-551)

**Helper functions (lines 462-472):**
```pine
bullRev(float wick, float body) =>
    sigC > sigO and sigL <= body and sigC > body and volPassBull
    and (not i_vwapFilter or sigC > vwapVal)

bearRev(float wick, float body) =>
    sigC < sigO and sigH >= body and sigC < body and volPassBear
    and (not i_vwapFilter or sigC < vwapVal)
```

**Zone/touch detection:**
- Bull reversal at LOW levels: wick must dip into zone (`sigL <= body`), close must reject above body edge (`sigC > body`)
- Bear reversal at HIGH levels: wick must push into zone (`sigH >= body`), close must reject below body edge (`sigC < body`)
- The `wick` parameter is passed but **not actually used** in the condition — only `body` (the body edge) matters
- Additional: candle must be directional (`sigC > sigO` for bull, `sigC < sigO` for bear)

**Raw signals (lines 514-522):** Each level type checked with per-level toggle (`i_revPM`, `i_revYest`, etc.)

**Filtered signals (lines 524-533):** `i_firstOnly` flag with per-level reversal flags (`rPML`, `rYL`, etc.)

**Re-arm (lines 425-440):** Reversal flags cleared when price moves decisively away from the rejection zone.

---

## 5. Counter-Trend / VWAP Filter (line 41, lines 466, 472)

**Input:** `i_vwapFilter` — defaults to `false` (line 41)

```pine
i_vwapFilter = input.bool(false, "VWAP Directional Filter (reversals)")
```

**Tooltip:** "Suppress bear reversals above VWAP, bull reversals below VWAP"

**Where applied:** Only in the `bullRev` and `bearRev` helpers:
- `bullRev` line 466: `and (not i_vwapFilter or not na(vwapVal) and sigC > vwapVal)`
- `bearRev` line 472: `and (not i_vwapFilter or not na(vwapVal) and sigC < vwapVal)`

**Current state:** OFF by default. Only affects reversals/reclaims, NOT breakouts. Uses `ta.vwap` (line 289).

**No other trend filter exists** — no EMA trend, no momentum filter, no structure filter.

---

## 6. Zone Width Calculation (lines 103-114)

**PM/ORB zones — ATR-derived (line 106-108, 113-114):**
```pine
zoneWidth = i_useZones ? dailyATR * i_zoneATRPct / 100.0 : 0.0
pmHBody   = pmHigh - zoneWidth      // body edge is wick minus ATR%
orbHBody  = orbHigh - zoneWidth
pmLBody   = pmLow  + zoneWidth      // body edge is wick plus ATR%
orbLBody  = orbLow  + zoneWidth
```
Default `i_zoneATRPct` = 3.0% of daily ATR (line 44).

**D/W zones — candle OHLC-derived (lines 109-112):**
```pine
yestHBody = math.max(yestOpen, yestClose)   // body top (wick = yestHigh)
yestLBody = math.min(yestOpen, yestClose)   // body bottom (wick = yestLow)
weekHBody = math.max(weekOpen, weekClose)
weekLBody = math.min(weekOpen, weekClose)
```
Uses actual candle body edges (max/min of open,close) — no ATR involved.

**When zones OFF (`i_useZones = false`):** body = wick, zone collapses to a single line (line 105 comment).

---

## 7. Level Merging

**No level merging logic exists.** There is no code to detect or merge closely-spaced levels.

The only "merging" is in the label system: when multiple breakouts fire on the same signal-TF bar, they get combined into one label with `+` separator (lines 563-581). This is same-bar confluence merging, not proximity-based level merging.

If PM High = 150.20 and Yest High = 150.25, both generate independent breakout signals and flags. They may or may not fire on the same bar depending on price action.

---

## 8. firstOnly / Cooldown (lines 12, 33, 484-510, 645-648, 686-689, 801-804)

### firstOnly (Once Per Breakout)
- Input: `i_firstOnly` (line 12), default `true`
- Breakout suppression: `sigBullPMH = rBullPMH and (not i_firstOnly or not xPMH)` (lines 485-492)
- After raw signal fires, flag set: `if rBullPMH: xPMH := true` (lines 495-510)
- Re-arm logic (lines 398-423): flag cleared when price closes back through level minus `rearmBuf`, setting `hadBrk*` = true
- Same pattern for reversals with `rPML`, `rYL`, etc. flags (lines 524-551)
- All flags reset at session open (lines 203-220)

### Cooldown Dimming
- Input: `i_cooldownBars` (line 33), default 2 signal bars
- Tracked via `lastBullSigBar` / `lastBearSigBar` (lines 645-646)
- Condition: `isCooled = i_cooldownBars > 0 and (sigBarIdx - lastBullSigBar) <= i_cooldownBars` (line 686)
- Effect: label color grayed out (`color.new(color.gray, 70)`), size reduced to `size.tiny`
- **Cooldown does NOT suppress signals** — it only dims them visually
- Cooled signals do NOT update `lastBullSigBar` (line 725: `if not isOld and not isCooled`)

### What prevents repeated signals:
1. `i_firstOnly` flags — primary mechanism, one signal per level per session (until re-armed)
2. `newSigBar` — signals only fire on new signal-TF bar boundaries
3. `isRegular` — only during regular trading hours
4. Per-level retest `bRT[i]` bools — prevent re-firing retest at same level
5. Cooldown — visual only, does not suppress
